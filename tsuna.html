<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Tug of War - Final</title>
    <style>
        :root { --p1: #ff4757; --p2: #2e86de; --bg: #1a1a1a; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* レイアウト */
        #game-container { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        .player-area { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; align-items: center; padding: 20px; box-sizing: border-box; }
        #p2-area { transform: rotate(180deg); }

        /* 綱引きバー */
        #tug-bar { width: 100%; height: 60px; background: var(--p2); position: relative; overflow: hidden; z-index: 10; box-shadow: 0 0 30px #000; }
        #p1-progress { height: 100%; width: 50%; background: var(--p1); transition: width 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1); position: absolute; left: 0; }
        #divider { position: absolute; right: -4px; width: 8px; height: 100%; background: #fff; box-shadow: 0 0 15px #fff; }

        /* ゲームUI */
        .question { color: white; font-size: 3rem; font-weight: 900; }
        .combo { color: #aaa; font-size: 1.2rem; font-weight: bold; height: 1.5rem; }
        .options { display: flex; gap: 10px; width: 100%; max-width: 500px; }
        .btn { flex: 1; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 20px 0; font-size: 1.8rem; border-radius: 15px; text-align: center; }
        .p1-btn:active { background: var(--p1); } .p2-btn:active { background: var(--p2); }

        /* メニュー & 勝利画面 */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; }
        .menu-side { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; gap: 15px; }
        .lv-btn { padding: 10px 20px; border: 2px solid #555; border-radius: 8px; color: #888; }
        .lv-btn.active { border-color: #fff; color: #fff; background: rgba(255,255,255,0.2); }
        .ready-btn { padding: 15px 50px; font-size: 1.5rem; border-radius: 40px; border: none; background: #333; color: #666; font-weight: bold; }
        .ready-btn.active { background: #2ecc71; color: white; }
        #winner-screen { display: none; z-index: 200; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

<div id="menu" class="overlay">
    <div class="menu-side" style="transform: rotate(180deg); border-bottom: 1px solid #333;">
        <h2 style="color:var(--p2)">PLAYER 2</h2>
        <div style="display:flex; gap:10px;">
            <div class="lv-btn active" onclick="setLv(2,'easy',event)">Easy</div>
            <div class="lv-btn" onclick="setLv(2,'norm',event)">Norm</div>
            <div class="lv-btn" onclick="setLv(2,'hard',event)">Hard</div>
        </div>
        <button id="ready-2" class="ready-btn" onclick="ready(2)">READY</button>
    </div>
    <div class="menu-side">
        <h2 style="color:var(--p1)">PLAYER 1</h2>
        <div style="display:flex; gap:10px;">
            <div class="lv-btn active" onclick="setLv(1,'easy',event)">Easy</div>
            <div class="lv-btn" onclick="setLv(1,'norm',event)">Norm</div>
            <div class="lv-btn" onclick="setLv(1,'hard',event)">Hard</div>
        </div>
        <button id="ready-1" class="ready-btn" onclick="ready(1)">READY</button>
    </div>
</div>

<div id="game-container">
    <div id="p2-area" class="player-area">
        <div id="p2-combo" class="combo"></div>
        <div id="p2-q" class="question"></div>
        <div class="options" id="p2-opt"></div>
    </div>
    <div id="tug-bar"><div id="p1-progress"><div id="divider"></div></div></div>
    <div id="p1-area" class="player-area">
        <div id="p1-q" class="question"></div>
        <div id="p1-combo" class="combo"></div>
        <div class="options" id="p1-opt"></div>
    </div>
</div>

<div id="winner-screen" class="overlay">
    <h1 id="win-txt" style="font-size:3rem"></h1>
    <p id="win-reason" style="color:#888; margin-bottom:30px;"></p>
    <button class="ready-btn active" onclick="location.reload()">REMATCH</button>
</div>

<script>
    let rope = 50, active = false, timer = null;
    const players = {
        1: { lv: 'easy', ready: false, q: {}, combo: 0, time: 0 },
        2: { lv: 'easy', ready: false, q: {}, combo: 0, time: 0 }
    };

    const setLv = (p, l, e) => {
        players[p].lv = l;
        e.target.parentNode.querySelectorAll('.lv-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
    };

    const ready = (p) => {
        players[p].ready = !players[p].ready;
        document.getElementById(`ready-${p}`).classList.toggle('active');
        if (players[1].ready && players[2].ready) {
            document.getElementById('menu').style.display = 'none';
            active = true; update(1); update(2);
            timer = setTimeout(() => end(rope > 50 ? 1 : (rope < 50 ? 2 : 0), "TIME UP!"), 60000);
        }
    };

    const update = (pId) => {
        if (!active) return;
        const p = players[pId], l = p.lv;
        let a, b, op, ans;
        if (l === 'easy') { op = Math.random() > 0.5 ? '+' : '-'; a = r(2,15); b = r(2,15); if(op==='-'){a=Math.max(a,b); b=Math.min(a,b);} ans = op==='+'?a+b:a-b; }
        else if (l === 'norm') { let t = r(0,2); if(t===0){op='+';a=r(15,70);b=r(15,70);ans=a+b;} else if(t===1){op='-';a=r(50,99);b=r(10,49);ans=a-b;} else{op='×';a=r(3,9);b=r(3,9);ans=a*b;} }
        else { let t = r(0,1); if(t===0){op='×';a=r(11,19);b=r(3,9);ans=a*b;} else{op='+';a=r(101,999);b=r(101,999);ans=a+b;} }
        
        let c = [ans]; while(c.length < 4) { let w = ans + r(-10,10); if(w>0 && !c.includes(w)) c.push(w); }
        p.q = { text: `${a}${op}${b}`, ans, ch: c.sort(() => Math.random() - 0.5) };
        p.time = Date.now();
        
        document.getElementById(`p${pId}-q`).innerText = p.q.text;
        document.getElementById(`p${pId}-combo`).innerText = p.combo > 1 ? `${p.combo} COMBO!` : "";
        const div = document.getElementById(`p${pId}-opt`); div.innerHTML = '';
        p.q.ch.forEach((val, i) => {
            const b = document.createElement('div'); b.className = `btn p${pId}-btn`; b.innerText = val;
            b.onclick = () => {
                if (val === p.q.ans) {
                    let pwr = {easy:2, norm:3.5, hard:6}[l] * Math.max(0.4, 2 - (Date.now()-p.time)/1000) * Math.pow(1.1, p.combo);
                    rope += (pId === 1 ? pwr : -pwr); p.combo++;
                    document.getElementById('p1-progress').style.width = `${Math.min(100, Math.max(0, rope))}%`;
                    if (rope >= 100) end(1, "K.O.!"); else if (rope <= 0) end(2, "K.O.!"); else update(pId);
                } else { p.combo = 0; div.style.opacity = 0.2; setTimeout(() => {div.style.opacity = 1; update(pId)}, 600); }
            };
            div.appendChild(b);
        });
    };

    const r = (n, m) => Math.floor(Math.random() * (m - n + 1)) + n;
    const end = (p, msg) => { active = false; clearTimeout(timer); document.getElementById('win-txt').innerText = p ? `PLAYER ${p} WINS!` : "DRAW!"; document.getElementById('win-reason').innerText = msg; document.getElementById('winner-screen').style.display = 'flex'; };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Tug of War</title>
    <style>
        :root {
            --p1-color: #ff4757;
            --p2-color: #2e86de;
            --bg-color: #2f3542;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Helvetica Neue', Arial, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        /* 全体コンテナ */
        #game-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
        }

        /* プレイヤーエリア共通 */
        .player-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
        }

        /* プレイヤー2（上側）を180度回転 */
        #p2-area {
            transform: rotate(180deg);
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        /* 中央の綱引きゲージ */
        #tug-bar-container {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 40px;
            transform: translateY(-50%);
            background: #444;
            z-index: 10;
            display: flex;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #rope-gradient {
            height: 100%;
            width: 50%; /* 初期位置 */
            background: linear-gradient(90deg, var(--p1-color) 0%, #fff 50%, var(--p2-color) 100%);
            transition: width 0.2s ease-out;
            position: relative;
        }

        #flag {
            position: absolute;
            right: -10px;
            top: -5px;
            width: 20px;
            height: 50px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }

        /* UI要素 */
        .question {
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }

        .btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 20px;
            font-size: 1.5rem;
            border-radius: 15px;
            text-align: center;
            active: background: rgba(255,255,255,0.4);
        }

        .p1-btn:active { background-color: var(--p1-color); }
        .p2-btn:active { background-color: var(--p2-color); }

        .stats {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* 勝利画面 */
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .winner-text { font-size: 3rem; font-weight: bold; margin-bottom: 20px; }
        #retry-btn { padding: 15px 40px; font-size: 1.5rem; border-radius: 30px; border: none; background: #2ecc71; color: white; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="p2-area" class="player-area">
        <div id="p2-q" class="question">Ready?</div>
        <div class="options">
            <div class="btn p2-btn" onclick="checkAnswer(2, 0)">?</div>
            <div class="btn p2-btn" onclick="checkAnswer(2, 1)">?</div>
            <div class="btn p2-btn" onclick="checkAnswer(2, 2)">?</div>
            <div class="btn p2-btn" onclick="checkAnswer(2, 3)">?</div>
        </div>
        <div id="p2-stats" class="stats">Combo: 0</div>
    </div>

    <div id="tug-bar-container">
        <div id="rope-gradient">
            <div id="flag"></div>
        </div>
    </div>

    <div id="p1-area" class="player-area">
        <div id="p1-q" class="question">Ready?</div>
        <div class="options">
            <div class="btn p1-btn" onclick="checkAnswer(1, 0)">?</div>
            <div class="btn p1-btn" onclick="checkAnswer(1, 1)">?</div>
            <div class="btn p1-btn" onclick="checkAnswer(1, 2)">?</div>
            <div class="btn p1-btn" onclick="checkAnswer(1, 3)">?</div>
        </div>
        <div id="p1-stats" class="stats">Combo: 0</div>
    </div>
</div>

<div id="overlay">
    <div id="winner-display" class="winner-text">PLAYER 1 WINS!</div>
    <button id="retry-btn" onclick="resetGame()">REMATCH</button>
</div>

<script>
    let ropePos = 50; // 0 (P2 win) to 100 (P1 win)
    const players = {
        1: { q: {}, combo: 0, startTime: 0 },
        2: { q: {}, combo: 0, startTime: 0 }
    };

    function generateQuestion() {
        const operators = ['+', '-', '×'];
        const op = operators[Math.floor(Math.random() * operators.length)];
        let a, b, ans;

        if (op === '×') {
            a = Math.floor(Math.random() * 9) + 1;
            b = Math.floor(Math.random() * 9) + 1;
            ans = a * b;
        } else {
            a = Math.floor(Math.random() * 50) + 10;
            b = Math.floor(Math.random() * 50) + 10;
            ans = (op === '+') ? a + b : a - b;
        }

        let choices = [ans];
        while (choices.length < 4) {
            let wrong = ans + (Math.floor(Math.random() * 10) - 5);
            if (!choices.includes(wrong)) choices.push(wrong);
        }
        choices.sort(() => Math.random() - 0.5);

        return { text: `${a} ${op === '×' ? '×' : op} ${b}`, ans, choices };
    }

    function updateUI(pId) {
        const p = players[pId];
        p.q = generateQuestion();
        p.startTime = Date.now();
        
        const qElem = document.getElementById(`p${pId}-q`);
        const btns = document.querySelectorAll(`#p${pId}-area .btn`);
        
        qElem.innerText = p.q.text;
        btns.forEach((btn, i) => {
            btn.innerText = p.q.choices[i];
            btn.style.opacity = "1";
        });
        document.getElementById(`p${pId}-stats`).innerText = `Combo: ${p.combo}`;
    }

    function checkAnswer(pId, choiceIdx) {
        const p = players[pId];
        const selected = p.q.choices[choiceIdx];

        if (selected === p.q.ans) {
            // 計算：速さボーナス (最大3秒で減衰)
            const timeTaken = (Date.now() - p.startTime) / 1000;
            const speedMult = Math.max(1, 3 - timeTaken);
            p.combo++;
            
            // 綱を引く量
            const pullPower = (1 + (p.combo * 0.1)) * speedMult;
            
            if (pId === 1) ropePos += pullPower;
            else ropePos -= pullPower;

            updateRope();
            checkWin();
        } else {
            p.combo = 0;
            // ミスペナルティ：一瞬ボタンを消す
            const btns = document.querySelectorAll(`#p${pId}-area .btn`);
            btns.forEach(b => b.style.opacity = "0.3");
        }
        
        updateUI(pId);
    }

    function updateRope() {
        const rope = document.getElementById('rope-gradient');
        rope.style.width = `${ropePos}%`;
    }

    function checkWin() {
        if (ropePos >= 100 || ropePos <= 0) {
            const winner = ropePos >= 100 ? "PLAYER 1" : "PLAYER 2";
            document.getElementById('winner-display').innerText = `${winner} WINS!`;
            document.getElementById('overlay').style.display = 'flex';
        }
    }

    function resetGame() {
        ropePos = 50;
        players[1].combo = 0;
        players[2].combo = 0;
        updateRope();
        updateUI(1);
        updateUI(2);
        document.getElementById('overlay').style.display = 'none';
    }

    // 初期化
    resetGame();
</script>
</body>
</html>

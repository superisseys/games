<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HIT & BLOW - CPU MODE</title>
<style>
:root {
--bg: #0a0a0a;
--panel: #161616;
--p1-blue: #00d9ff;
--p2-pink: #ff007b;
--text: #ececec;
}
* { box-sizing: border-box; -webkit-user-select: none; user-select: none; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; }
body { background: var(--bg); color: var(--text); margin: 0; padding: 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

.info-bar { display: flex; justify-content: space-between; padding: 5px 10px; font-size: 0.75rem; font-weight: bold; border-bottom: 1px solid #333; }
.main-content { display: flex; flex: 1; gap: 10px; margin-top: 10px; overflow: hidden; }
.control-panel { flex: 1.2; display: flex; flex-direction: column; gap: 10px; }

.display-box { 
background: var(--panel); border: 2px solid #333; border-radius: 8px;
padding: 10px; text-align: center; 
}
.input-view { font-size: 1.8rem; font-weight: bold; letter-spacing: 8px; color: #fff; height: 40px; }
.status-msg { font-size: 0.7rem; color: #888; margin-top: 4px; overflow: hidden; white-space: nowrap; }

.keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
.key { 
aspect-ratio: 1.3 / 1; background: #252525; border: none; 
color: #fff; font-size: 1.2rem; font-weight: bold; border-radius: 6px; cursor: pointer;
}
.key:active:not(.disabled) { background: #444; }
.key.disabled { opacity: 0.1; pointer-events: none; }
.key.clear { color: #888; font-size: 0.9rem; }
.key.go { background: #eee; color: #000; font-size: 1rem; }

.history-panel { flex: 0.8; background: #111; border-radius: 8px; border: 1px solid #222; display: flex; flex-direction: column; }
.history-header { font-size: 0.65rem; padding: 6px; color: #666; border-bottom: 1px solid #222; text-align: center; }
.history-list { flex: 1; overflow-y: auto; padding: 4px; }
.history-row { 
display: flex; justify-content: space-between; padding: 6px 4px; 
border-bottom: 1px solid #1a1a1a; font-size: 0.85rem; font-family: monospace; 
}
.h-val { color: var(--p1-blue); font-weight: bold; }
.b-val { color: var(--p2-pink); font-weight: bold; }

.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; padding: 20px; }
.overlay.active { display: flex; }
.popup { background: #000; border: 2px solid var(--p1-blue); padding: 20px; border-radius: 12px; width: 280px; }
.btn-start { background: #fff; color: #000; padding: 10px 20px; border: none; font-size: 0.9rem; font-weight: bold; border-radius: 20px; margin: 5px; cursor: pointer; width: 100%; }
.btn-start.cpu { background: #222; color: var(--p1-blue); border: 1px solid var(--p1-blue); }

.btn-reset { margin-top: 5px; background: transparent; color: #444; border: 1px solid #333; padding: 4px 10px; border-radius: 10px; font-size: 0.65rem; }
</style>
</head>
<body>

<div class="info-bar">
<div id="round-text">ROUND 0</div>
<div id="mode-text">SELECT MODE</div>
</div>

<div class="main-content">
<div class="control-panel">
<div class="display-box" id="main-panel">
<div id="input-view" class="input-view">---</div>
<div id="msg" class="status-msg">WAITING</div>
</div>

<div class="keypad">
<button class="key num" onclick="pressNum(1)">1</button>
<button class="key num" onclick="pressNum(2)">2</button>
<button class="key num" onclick="pressNum(3)">3</button>
<button class="key num" onclick="pressNum(4)">4</button>
<button class="key num" onclick="pressNum(5)">5</button>
<button class="key num" onclick="pressNum(6)">6</button>
<button class="key num" onclick="pressNum(7)">7</button>
<button class="key num" onclick="pressNum(8)">8</button>
<button class="key num" onclick="pressNum(9)">9</button>
<button class="key clear" onclick="pressClear()">CLR</button>
<button class="key num" onclick="pressNum(0)">0</button>
<button class="key go" onclick="pressEnter()">GO</button>
</div>
<button class="btn-reset" onclick="confirmReset()">RESET GAME</button>
</div>

<div class="history-panel">
<div class="history-header">HISTORY (H / B)</div>
<div class="history-list" id="history-list"></div>
</div>
</div>

<div id="mode-overlay" class="overlay active">
<div class="popup" style="border-color: #fff;">
<h3 style="margin:0 0 15px 0">HIT & BLOW</h3>
<div style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">【対人対戦モード】</div>
<button class="btn-start" onclick="selectMode(3, 'VS')">3桁で対戦</button>
<button class="btn-start" onclick="selectMode(4, 'VS')">4桁で対戦</button>
<div style="font-size: 0.7rem; color: #888; margin: 15px 0 5px 0;">【1人プレイモード】</div>
<button class="btn-start cpu" onclick="selectMode(3, 'CPU')">3桁 (CPU設定)</button>
<button class="btn-start cpu" onclick="selectMode(4, 'CPU')">4桁 (CPU設定)</button>
</div>
</div>

<div id="notice-overlay" class="overlay">
<div class="popup" id="notice-box">
<h3 id="notice-title" style="margin:0"></h3>
<p id="notice-sub" style="margin:10px 0; font-size: 0.8rem; color: #888;"></p>
<button class="btn-start" onclick="hideNotice()">開始</button>
</div>
</div>

<script>
let answer = [], currentInput = [], digitLimit = 3, mode = 'SETTING', gameType = 'VS', history = [];

function selectMode(n, type) {
digitLimit = n;
gameType = type;
document.getElementById('mode-overlay').classList.remove('active');
document.getElementById('mode-text').innerText = `${digitLimit} DIGITS (${gameType})`;

if (gameType === 'CPU') {
setRandomAnswer();
} else {
startSetting();
}
}

// CPU用のランダム数字生成（重複なし）
function setRandomAnswer() {
let nums = [0,1,2,3,4,5,6,7,8,9];
answer = [];
for (let i = 0; i < digitLimit; i++) {
let idx = Math.floor(Math.random() * nums.length);
answer.push(nums[idx]);
nums.splice(idx, 1);
}
// 即座にプレイモードへ
mode = 'PLAYING';
currentInput = [];
history = [];
document.getElementById('history-list').innerHTML = '';
document.getElementById('msg').innerText = "子：数字を推理";
document.getElementById('main-panel').style.borderColor = "var(--p1-blue)";
updateView();
}

function startSetting() {
mode = 'SETTING';
answer = []; currentInput = []; history = [];
document.getElementById('history-list').innerHTML = '';
document.getElementById('msg').innerText = "親：答えをセット";
document.getElementById('main-panel').style.borderColor = "var(--p2-pink)";
updateView();
}

function pressNum(n) {
if (currentInput.length < digitLimit && !currentInput.includes(n)) {
currentInput.push(n);
updateView();
}
}

function pressClear() {
currentInput = [];
updateView();
}

function updateView() {
let display = "";
for (let i = 0; i < digitLimit; i++) {
display += (currentInput[i] !== undefined) ? currentInput[i] : "-";
}
document.getElementById('input-view').innerText = display;

const keys = document.querySelectorAll('.key.num');
keys.forEach(k => {
const val = parseInt(k.innerText);
k.className = currentInput.includes(val) ? 'key num disabled' : 'key num';
});
}

function pressEnter() {
if (currentInput.length !== digitLimit) return;
if (mode === 'SETTING') {
answer = [...currentInput];
currentInput = [];
mode = 'PLAYING';
showNotice("交代", "端末を子に渡してください", "var(--p1-blue)");
} else {
checkAnswer();
}
}

function checkAnswer() {
let hits = 0, blows = 0;
for (let i = 0; i < digitLimit; i++) {
if (currentInput[i] === answer[i]) hits++;
else if (answer.includes(currentInput[i])) blows++;
}
history.unshift({ guess: currentInput.join(""), hit: hits, blow: blows });
renderHistory();

if (hits === digitLimit) {
showNotice("正解！", `${history.length}回目でクリア`, "var(--gold)");
document.querySelector('#notice-overlay button').onclick = () => location.reload();
} else {
currentInput = [];
updateView();
document.getElementById('msg').innerText = `${hits} Hit / ${blows} Blow`;
}
}

function renderHistory() {
const list = document.getElementById('history-list');
list.innerHTML = history.map(item => `
<div class="history-row">
<span>${item.guess}</span>
<span><span class="h-val">${item.hit}</span> / <span class="b-val">${item.blow}</span></span>
</div>
`).join('');
document.getElementById('round-text').innerText = `ROUND ${history.length}`;
}

function showNotice(title, sub, color) {
const box = document.getElementById('notice-box');
box.style.borderColor = color;
document.getElementById('notice-title').innerText = title;
document.getElementById('notice-title').style.color = color;
document.getElementById('notice-sub').innerText = sub;
document.getElementById('notice-overlay').classList.add('active');
}

function hideNotice() {
document.getElementById('notice-overlay').classList.remove('active');
if (mode === 'PLAYING') {
document.getElementById('msg').innerText = "子：数字を推理";
document.getElementById('main-panel').style.borderColor = "var(--p1-blue)";
}
updateView();
}

function confirmReset() { if(confirm("リセットしますか？")) location.reload(); }
</script>

</body>
</html>